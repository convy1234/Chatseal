<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WhatsApp Chat (Simple)</title>
    <style>
      body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
      .card { max-width: 680px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; }
      h1 { margin: 0 0 10px 0; }
      label { display: block; margin-top: 10px; font-size: 14px; color: #374151; }
      input { width: 100%; padding: 10px; margin-top: 4px; border: 1px solid #d1d5db; border-radius: 6px; }
      button { margin-top: 10px; padding: 10px 16px; cursor: pointer; }
      #chatBox { border: 1px solid #d1d5db; height: 360px; overflow-y: auto; padding: 10px; margin-top: 12px; background: #fafafa; }
      .msg { margin: 6px 0; }
      .outbound { text-align: right; color: #065f46; }
      .inbound { text-align: left; color: #111827; }
      .row { display: flex; gap: 8px; margin-top: 8px; }
      .row input { flex: 1; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>WhatsApp Chat (Simple)</h1>

      <p>This page lets you join a tenant room, see inbound/outbound messages, and send a text message via your connected WhatsApp API.</p>

      <label>Tenant ID (Mongo ObjectId from your backend)</label>
      <input id="tenantId" placeholder="e.g. 652f0a..." />

      <label>Recipient WhatsApp Number (E.164 without +)</label>
      <input id="recipient" placeholder="e.g. 2348012345678" />

      <button id="joinBtn">Join Room</button>

      <div id="chatBox"></div>

      <div class="row">
        <input id="compose" placeholder="Type a message" />
        <button id="sendBtn">Send</button>
      </div>

      <p id="status" style="color:#6b7280; font-size: 14px; margin-top: 8px;">Idle</p>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      const BASE_URL = window.location.origin; // same origin as this static page
      const chatBox = document.getElementById('chatBox');
      const tenantInput = document.getElementById('tenantId');
      const recipientInput = document.getElementById('recipient');
      const compose = document.getElementById('compose');
      const sendBtn = document.getElementById('sendBtn');
      const joinBtn = document.getElementById('joinBtn');
      const status = document.getElementById('status');

      let currentTenantId = '';
      let currentRecipient = '';

      const socket = io(BASE_URL, { transports: ["websocket", "polling"] });

      function appendMessage(msg) {
        const div = document.createElement('div');
        div.className = `msg ${msg.direction === 'outbound' ? 'outbound' : 'inbound'}`;
        div.textContent = (msg.direction === 'outbound' ? 'You: ' : 'User: ') + (msg.message || '');
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      joinBtn.onclick = async () => {
        currentTenantId = tenantInput.value.trim();
        currentRecipient = recipientInput.value.trim();
        if (!currentTenantId) { alert('Enter Tenant ID'); return; }
        if (!currentRecipient) { alert('Enter recipient WhatsApp number (E.164 digits only, no +)'); return; }

        chatBox.innerHTML = '';
        status.textContent = 'Joining room and loading messages...';

        try {
          socket.emit('joinTenantRoom', currentTenantId);
          const res = await fetch(`${BASE_URL}/api/whatsapp/messages/${currentTenantId}`);
          const data = await res.json();
          (data.messages || []).forEach(appendMessage);
          status.textContent = 'Ready';
        } catch (e) {
          status.textContent = 'Failed to load messages';
        }
      };

      socket.on('newMessage', (msg) => {
        if (currentTenantId && String(msg.tenantId) === String(currentTenantId)) {
          appendMessage(msg);
        }
      });

      sendBtn.onclick = async () => {
        if (!currentTenantId) { alert('Join a tenant first'); return; }
        if (!currentRecipient) { alert('Enter recipient WhatsApp number'); return; }
        const message = compose.value.trim();
        if (!message) return;
        status.textContent = 'Sending...';
        try {
          await fetch(`${BASE_URL}/api/whatsapp/messages/send`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tenantId: currentTenantId, to: currentRecipient, message })
          });
          compose.value = '';
          status.textContent = 'Sent';
        } catch (e) {
          status.textContent = 'Send failed';
        }
      };
    </script>
  </body>
  </html>

